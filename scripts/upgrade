#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

email=$(ynh_user_get_info --username=$admin --key=mail)

#=================================================
# STOP SYSTEMD SERVICE
#=================================================
ynh_script_progression "Stopping systemd service '$app'..."

ynh_systemctl --service=$app --action="stop" --log_path="$log_file"

#=================================================
# PYTHON VIRTUALENV
#=================================================
ynh_script_progression "Setup Python virtualenv for $app ..."
ynh_safe_rm "$data_dir/.venv" # FIXME: We should probably not install anything in $data_dir
                              # $install_dir is meant for that
ynh_exec_as_app python3 -m venv $data_dir/.venv
ynh_exec_as_app $data_dir/.venv/bin/pip install -r "../conf/requirements.txt"

#=================================================
# copy config files
# ================================================
ynh_script_progression "Create project configuration files..."

ynh_app_setting_set_default --key=default_longitude --value="2.0"
ynh_app_setting_set_default --key=default_latitude --value="51.0"
ynh_app_setting_set_default --key=default_zoom --value=6
ynh_app_setting_set_default --key=openrouteservice --value=""
ynh_app_setting_set_default --key=allow_anonymous --value=0
ynh_app_setting_set_default --key=realtime --value=1
ynh_config_add --template="settings.py" --destination="$data_dir/settings.py"
ynh_config_add --template="setup_user.py" --destination="$data_dir/setup_user.py"
ynh_config_add --template="env" --destination="$data_dir/env"

#=================================================
# MIGRATE APP
#=================================================
ynh_script_progression "migrate/collectstatic/createadmin..."

pushd "$data_dir"
    set -a
    . $data_dir/.env
    set +a

    # Just for debugging:
    $data_dir/.venv/bin/umap diffsettings

    $data_dir/.venv/bin/umap collectstatic --no-input
    ynh_psql_db_shell $db_name <<< "CREATE EXTENSION IF NOT EXISTS postgis;"
    ynh_psql_db_shell $db_name <<< "CREATE EXTENSION IF NOT EXISTS unaccent;"
    $data_dir/.venv/bin/umap migrate --no-input

    # Check the configuration
    # This may fail in some cases with errors, etc., but the app works and the user can fix issues later.
    $data_dir/.venv/bin/umap check --deploy || true
popd

#=================================================
# REAPPLY SYSTEM CONFIGURATIONS
#=================================================
ynh_script_progression "Upgrading system configurations related to $app..."

ynh_config_add_nginx

ynh_config_add_systemd

yunohost service add "$app" --description="Create maps with OpenStreetMap layers" --log="/var/log/$app/$app.log"

ynh_config_add_logrotate

#=================================================
# SECURE FILES AND DIRECTORIES
#=================================================
ynh_script_progression "Set $app file permissions..."

myynh_fix_file_permissions

#=================================================
# Start the app server via systemd
#=================================================
ynh_script_progression "Starting systemd service '$app'..."

ynh_systemctl --service=$app --action=restart --log_path=systemd

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
